name: Build and Release

on:
  workflow_run:
    workflows: ["CI - Verify Azure VM Operations"]
    types:
      - completed
    branches:
      - main
  release:
    types: [created, published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  check-ci-status:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      has_main_py: ${{ steps.check_files.outputs.has_main_py }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 2

    - name: Check if main.py exists or was modified
      id: check_files
      run: |
        HAS_MAIN_PY="false"
        
        # For workflow_dispatch or release events, always allow
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "release" ]; then
          echo "Manual trigger or release event - skipping file check"
          HAS_MAIN_PY="true"
        # For workflow_run triggered by push
        elif [ "${{ github.event_name }}" == "workflow_run" ]; then
          # Check if main.py exists in the repository
          if [ -f "main.py" ]; then
            echo "âœ“ main.py exists in repository"
            
            # Check if main.py was modified in recent commits
            if git diff --name-only HEAD~1 HEAD | grep -q "main.py"; then
              echo "âœ“ main.py was modified in this push"
              HAS_MAIN_PY="true"
            else
              echo "âš  main.py exists but was not modified in this push"
              echo "â„¹ Skipping release - only releases when main.py is modified"
              HAS_MAIN_PY="false"
            fi
          else
            echo "âœ— main.py not found in repository - skipping release"
            HAS_MAIN_PY="false"
          fi
        else
          # For other events, check if main.py exists
          if [ -f "main.py" ]; then
            HAS_MAIN_PY="true"
          fi
        fi
        
        echo "has_main_py=$HAS_MAIN_PY" >> $GITHUB_OUTPUT
        echo "Main.py check result: $HAS_MAIN_PY"

    - name: Check CI status
      id: check
      run: |
        echo "CI workflow completed successfully or manual trigger"
        
        if [ "${{ steps.check_files.outputs.has_main_py }}" == "true" ]; then
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "âœ“ Release will proceed (main.py requirement satisfied)"
        else
          echo "should_release=false" >> $GITHUB_OUTPUT
          echo "âœ— Release skipped (main.py not found or not modified)"
        fi

  build-package:
    needs: check-ci-status
    if: needs.check-ci-status.outputs.should_release == 'true' && needs.check-ci-status.outputs.has_main_py == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      wheel_name: ${{ steps.build.outputs.wheel_name }}
      sdist_name: ${{ steps.build.outputs.sdist_name }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel setuptools

    - name: Get version from pyproject.toml
      id: get_version
      run: |
        VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"

    - name: Build wheel and source distribution
      id: build
      run: |
        echo "Building Python package..."
        python -m build
        
        # Get built file names
        WHEEL_FILE=$(ls dist/*.whl | head -n 1)
        SDIST_FILE=$(ls dist/*.tar.gz | head -n 1)
        
        WHEEL_NAME=$(basename "$WHEEL_FILE")
        SDIST_NAME=$(basename "$SDIST_FILE")
        
        echo "wheel_name=$WHEEL_NAME" >> $GITHUB_OUTPUT
        echo "sdist_name=$SDIST_NAME" >> $GITHUB_OUTPUT
        
        echo "Built files:"
        ls -lh dist/
        
        echo "Wheel file: $WHEEL_NAME"
        echo "Source distribution: $SDIST_NAME"

    - name: Check package with twine
      run: |
        echo "Checking package integrity..."
        twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 5

  publish-to-pypi:
    needs: build-package
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '')
    environment:
      name: pypi
      url: https://pypi.org/project/avmoperation/
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: List distribution files
      run: |
        echo "Distribution files to publish:"
        ls -lh dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true
        verbose: true

    - name: Verify PyPI publication
      run: |
        echo "Package published to PyPI successfully!"
        echo "Install with: pip install avmoperation"

  publish-to-github-release:
    needs: build-package
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Get version and prepare release info
      id: release_info
      run: |
        VERSION="${{ needs.build-package.outputs.version }}"
        
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        # Remove 'v' prefix if present
        VERSION_CLEAN="${VERSION#v}"
        
        echo "version=v${VERSION_CLEAN}" >> $GITHUB_OUTPUT
        echo "version_clean=${VERSION_CLEAN}" >> $GITHUB_OUTPUT
        
        # Generate release notes
        cat > release_notes.md << 'EOF'
        ## ðŸ“¦ Release v${{ needs.build-package.outputs.version }}
        
        ### Installation
        
        #### From PyPI
        ```bash
        pip install avmoperation
        ```
        
        #### From GitHub Release
        ```bash
        pip install ${{ needs.build-package.outputs.wheel_name }}
        ```
        
        #### From Source
        ```bash
        pip install ${{ needs.build-package.outputs.sdist_name }}
        ```
        
        ### What's Included
        - âœ… Wheel distribution (`.whl`)
        - âœ… Source distribution (`.tar.gz`)
        - âœ… Ready for PyPI publication
        
        ### Features
        - Azure VM start/stop operations
        - VM status checking
        - Webhook notifications support
        - Service Principal authentication
        
        ---
        **Full Changelog**: https://github.com/${{ github.repository }}/commits/v${{ needs.build-package.outputs.version }}
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.release_info.outputs.version }}
        name: Release ${{ steps.release_info.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          dist/*.whl
          dist/*.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Release summary
      run: |
        echo "ðŸŽ‰ Release ${{ steps.release_info.outputs.version }} created successfully!"
        echo "ðŸ“¦ Wheel: ${{ needs.build-package.outputs.wheel_name }}"
        echo "ðŸ“¦ Source: ${{ needs.build-package.outputs.sdist_name }}"
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.version }}"

  publish-to-github-packages:
    needs: build-package
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Install twine
      run: |
        pip install twine

    - name: Configure package index for GitHub Packages
      run: |
        cat > ~/.pypirc << EOF
        [distutils]
        index-servers =
            github

        [github]
        repository = https://upload.pypi.org/legacy/
        username = __token__
        password = ${{ secrets.GITHUB_TOKEN }}
        EOF

    - name: Publish to GitHub Packages
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        TWINE_REPOSITORY_URL: https://maven.pkg.github.com/${{ github.repository_owner }}
      run: |
        echo "Publishing to GitHub Packages..."
        
        # Note: GitHub Packages for Python uses package registry
        # We'll upload artifacts to the release instead
        echo "Packages are available in GitHub Releases"
        echo "Install with: pip install https://github.com/${{ github.repository }}/releases/download/v${{ needs.build-package.outputs.version }}/${{ needs.build-package.outputs.wheel_name }}"

    - name: Package registry summary
      run: |
        echo "ðŸ“¦ Packages published to GitHub"
        echo "ðŸ”— Wheel: ${{ needs.build-package.outputs.wheel_name }}"
        echo "ðŸ”— Source: ${{ needs.build-package.outputs.sdist_name }}"

  build-summary:
    needs: [build-package, publish-to-pypi, publish-to-github-release, publish-to-github-packages]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Build and Release Summary
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“¦ Build and Release Summary"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Version: ${{ needs.build-package.outputs.version }}"
        echo "Wheel: ${{ needs.build-package.outputs.wheel_name }}"
        echo "Source: ${{ needs.build-package.outputs.sdist_name }}"
        echo ""
        echo "Publication Status:"
        echo "  PyPI: ${{ needs.publish-to-pypi.result }}"
        echo "  GitHub Release: ${{ needs.publish-to-github-release.result }}"
        echo "  GitHub Packages: ${{ needs.publish-to-github-packages.result }}"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "â„¹ï¸  Note: This workflow only triggers when:"
        echo "   - main.py is modified in the push (for automatic releases)"
        echo "   - A GitHub release is created"
        echo "   - Workflow is manually triggered"
